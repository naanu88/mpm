<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dynamic Math Problem Generator</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #22c55e;
      --accent2: #60a5fa;
      --danger: #ef4444;
      --warning: #f59e0b;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      line-height: 1.5;
    }
    header {
      padding: 24px 16px; text-align: center;
      border-bottom: 1px solid #1f2937;
      background: linear-gradient(180deg, #0b1222, var(--bg));
    }
    header h1 { margin: 0; font-size: 1.8rem; letter-spacing: .3px; }
    header p { margin: 6px 0 0; color: var(--muted); }
    .container {
      max-width: 1100px; margin: 0 auto; padding: 20px 16px;
      display: grid; grid-template-columns: 1fr 2fr; gap: 16px;
    }
    .card {
      background: var(--card); border: 1px solid #1f2937; border-radius: 12px;
      padding: 16px;
    }
    .card h2 { margin: 0 0 12px; font-size: 1.2rem; }
    .controls .row {
      display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;
      margin-bottom: 12px;
    }
    label { font-size: .9rem; color: var(--muted); display: block; margin-bottom: 6px; }
    select, input[type="text"], input[type="number"] {
      width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #374151;
      background: #0b1222; color: var(--text);
    }
    .btns { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 8px; }
    button {
      background: #1f2937; color: var(--text); border: 1px solid #374151; padding: 10px 14px;
      border-radius: 8px; cursor: pointer;
    }
    button.primary { background: var(--accent); border-color: #16a34a; color: #082f1f; font-weight: 600; }
    button.secondary { background: var(--accent2); border-color: #3b82f6; color: #0b213f; font-weight: 600; }
    button.warn { background: var(--warning); border-color: #d97706; color: #3a2500; font-weight: 600; }
    button.danger { background: var(--danger); border-color: #b91c1c; color: #3a0000; font-weight: 600; }
    .problem {
      font-size: 1.08rem; white-space: pre-wrap;
    }
    .meta { color: var(--muted); font-size: .9rem; margin-bottom: 8px; }
    .answer-area { display: grid; grid-template-columns: 2fr 1fr auto; gap: 10px; align-items: center; margin-top: 12px; }
    .badge {
      display: inline-block; font-size: .8rem; padding: 4px 8px; border-radius: 999px;
      border: 1px solid #374151; background: #0b1222; color: var(--muted); margin-right: 6px;
    }
    .ok { color: #10b981; }
    .no { color: #ef4444; }
    .solution {
      background: #0b1222; border: 1px dashed #374151; border-radius: 8px; padding: 12px; margin-top: 12px;
      font-size: .95rem;
    }
    .footer { text-align: center; color: var(--muted); font-size: .85rem; padding: 18px 0 26px; }
    .split { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    code.seed { background: #0b1222; border: 1px solid #374151; padding: 2px 6px; border-radius: 6px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .count { font-size: .9rem; color: var(--muted); }
    @media (max-width: 900px) {
      .container { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Dynamic Math Problem Generator</h1>
    <p>Pick a branch, difficulty, and style. Generate infinitely varied, checkable problems with solutions.</p>
  </header>

  <div class="container">
    <div class="card controls">
      <h2>Controls</h2>

      <div class="row">
        <div>
          <label for="branch">Branch of maths</label>
          <select id="branch">
            <option>Arithmetic</option>
            <option>Algebra</option>
            <option>Ratios & Proportions</option>
            <option>Rates</option>
            <option>Percentages</option>
            <option>Geometry</option>
            <option>Probability</option>
            <option>Statistics</option>
            <option>Number Theory</option>
            <option>Sequences & Series</option>
            <option>Functions</option>
            <option>Linear Equations</option>
            <option>Systems of Equations</option>
            <option>Exponents & Radicals</option>
          </select>
        </div>
        <div>
          <label for="difficulty">Difficulty</label>
          <select id="difficulty">
            <option>easy</option>
            <option>medium</option>
            <option>hard</option>
            <option>harder</option>
            <option>EXTREME</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="style">Problem style</label>
          <select id="style">
            <option>Normal</option>
            <option>Word Problem</option>
            <option>Problem Solving</option>
          </select>
        </div>
        <div>
          <label for="seed">Seed (optional, reproducible)</label>
          <input id="seed" type="text" placeholder="e.g., MATH-2025-42" />
        </div>
      </div>

      <div class="btns">
        <button id="generate" class="primary">Generate problem</button>
        <button id="randomize" class="secondary">Randomize options</button>
        <button id="copyLink" class="warn">Copy shareable link</button>
        <button id="newSeed">New seed</button>
      </div>
      <div class="count" id="comboCount"></div>
    </div>

    <div class="card">
      <h2>Problem</h2>
      <div class="meta" id="meta"></div>
      <div class="problem" id="problem">Choose settings and click “Generate problem”.</div>

      <div class="answer-area">
        <input id="answer" type="text" placeholder="Enter your answer (number, fraction, etc.)" />
        <button id="check" class="primary">Check answer</button>
        <span id="feedback" class="badge"></span>
      </div>

      <div class="split">
        <button id="showSolution">Show solution</button>
        <button id="newProblem">New problem (same settings)</button>
        <span>Seed: <code class="seed" id="seedDisplay">—</code></span>
      </div>

      <div class="solution" id="solution" style="display:none;"></div>
    </div>
  </div>

  <div class="footer">
    Built for Github Pages. 100% client-side. Shareable seeds. Infinite variation.
  </div>

<script>
/* ===== Utilities ===== */
const state = {
  branch: 'Arithmetic',
  difficulty: 'easy',
  style: 'Normal',
  seed: null,
  rng: null,
  current: null,
};
const branches = [
  'Arithmetic','Algebra','Ratios & Proportions','Rates','Percentages','Geometry','Probability',
  'Statistics','Number Theory','Sequences & Series','Functions','Linear Equations',
  'Systems of Equations','Exponents & Radicals'
];
const difficulties = ['easy','medium','hard','harder','EXTREME'];
const styles = ['Normal','Word Problem','Problem Solving'];

function hashSeed(str) {
  let h = 2166136261 >>> 0;
  for (let i=0;i<str.length;i++) {
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h >>> 0;
}
function makeRNG(seed) {
  let a = (seed ^ 0x9E3779B9) >>> 0, b = (seed ^ 0x243F6A88) >>> 0, c = (seed ^ 0xB7E15162) >>> 0, d = (seed ^ 0xC6EF3720) >>> 0;
  return function() {
    a = (a ^ (a << 11)) >>> 0;
    b = (b ^ (b >>> 7)) >>> 0;
    c = (c ^ (c << 17)) >>> 0;
    d = (d ^ (d >>> 13)) >>> 0;
    const t = (a + b + c + d) >>> 0;
    return (t / 0xFFFFFFFF);
  };
}
function rndInt(rng, min, max) {
  return Math.floor(rng() * (max - min + 1)) + min;
}
function choice(rng, arr) {
  return arr[Math.floor(rng() * arr.length)];
}
function shuffle(rng, arr) {
  const a = arr.slice();
  for (let i=a.length-1; i>0; i--) {
    const j = Math.floor(rng() * (i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
/* Number formatting and parsing */
function formatFrac(numer, denom) {
  const g = gcd(Math.abs(numer), Math.abs(denom));
  numer /= g; denom /= g;
  if (denom === 1) return String(numer);
  if (denom < 0) { denom = -denom; numer = -numer; }
  return `${numer}/${denom}`;
}
function gcd(a,b){ return b ? gcd(b, a%b) : a; }
function approxEqual(a,b,eps=1e-6){ return Math.abs(a-b) < eps; }
function parseAnswer(str) {
  str = String(str || '').trim();
  if (!str) return null;
  // fraction?
  if (str.includes('/')) {
    const [n,d] = str.split('/').map(s => s.trim());
    const numer = Number(n), denom = Number(d);
    if (Number.isFinite(numer) && Number.isFinite(denom) && denom !== 0) {
      return numer / denom;
    }
  }
  const val = Number(str);
  if (Number.isFinite(val)) return val;
  // percentage like "45%" -> 0.45
  if (str.endsWith('%')) {
    const p = Number(str.slice(0,-1));
    if (Number.isFinite(p)) return p/100;
  }
  return null;
}
/* Difficulty scaffolding (controls ranges/complexity) */
const diffConf = {
  easy:   { range: 10, steps: 2, terms: 2, decimals: false },
  medium: { range: 25, steps: 3, terms: 3, decimals: false },
  hard:   { range: 50, steps: 4, terms: 3, decimals: true },
  harder: { range: 100, steps: 5, terms: 4, decimals: true },
  EXTREME:{ range: 200, steps: 6, terms: 5, decimals: true }
};
/* Styles decorators */
function styleWrap(style, text, context) {
  if (style === 'Normal') return text;
  if (style === 'Word Problem') {
    const names = ['Ava','Liam','Mia','Noah','Zoe','Ethan','Isla','Leo','Chloe','Jack'];
    const places = ['a market','a school','a lab','a track','a cafe','a farm','a library','a workshop'];
    const who = context?.name || names[rndInt(state.rng,0,names.length-1)];
    const where = context?.place || places[rndInt(state.rng,0,places.length-1)];
    return `${who} is at ${where}. ${text}`;
  }
  // Problem Solving style adds an extra prompt layer
  return `${text}\n\nExplain your reasoning and justify each step before giving the final answer.`;
}

/* ===== Problem templates per branch ===== */
/* Each generator returns: { prompt, answer, steps, context } */
const Generators = {
  'Arithmetic': (rng, d, style) => {
    const cfg = diffConf[d];
    const ops = ['+','-','×','÷'];
    const a = rndInt(rng, 1, cfg.range);
    const b = rndInt(rng, 1, cfg.range);
    const op = choice(rng, ops);
    let ans, steps = [];
    if (op === '+') { ans = a + b; steps = [`Add ${a} and ${b}.`, `Result: ${ans}.`]; }
    if (op === '-') { ans = a - b; steps = [`Subtract ${b} from ${a}.`, `Result: ${ans}.`]; }
    if (op === '×') { ans = a * b; steps = [`Multiply ${a} by ${b}.`, `Result: ${ans}.`]; }
    if (op === '÷') {
      const numer = a*b; // ensure integer division possibility
      ans = numer / a;
      steps = [`Construct ${numer} ÷ ${a}.`, `Compute: ${numer}/${a} = ${ans}.`];
      return {
        prompt: styleWrap(style, `Compute ${numer} ÷ ${a}.`, {}),
        answer: ans, steps
      };
    }
    return { prompt: styleWrap(style, `Compute ${a} ${op} ${b}.`, {}), answer: ans, steps };
  },

  'Algebra': (rng, d, style) => {
    const cfg = diffConf[d];
    const m = rndInt(rng, 1, cfg.range);
    const x = rndInt(rng, 1, cfg.range);
    const c = rndInt(rng, -cfg.range, cfg.range);
    const y = m*x + c;
    const form = choice(rng, ['solve','expand','factor']);
    if (form === 'solve') {
      const a = rndInt(rng, 1, cfg.range);
      const b = rndInt(rng, -cfg.range, cfg.range);
      const sol = (y - b) / a;
      const steps = [
        `Given a linear relation: y = ${m}x + ${c}.`,
        `Equation: ${a}x + ${b} = y.`,
        `Substitute y = ${y}.`,
        `Solve for x: x = (y - ${b})/${a} = ${sol}.`
      ];
      return { prompt: styleWrap(style, `If y = ${y} and y = ${m}x + ${c}, solve ${a}x + ${b} = y for x.`, {}), answer: sol, steps };
    }
    if (form === 'expand') {
      const p = rndInt(rng, 1, cfg.range);
      const q = rndInt(rng, -cfg.range, cfg.range);
      const steps = [
        `Compute (x + ${p})(x + ${q}).`,
        `Expand: x^2 + (${p}+${q})x + ${p*q}.`
      ];
      return { prompt: styleWrap(style, `Expand (x + ${p})(x + ${q}) and give the coefficient of x.`, {}), answer: p+q, steps };
    }
    // factor
    const r = rndInt(rng, 1, Math.floor(cfg.range/2));
    const s = rndInt(rng, 1, Math.floor(cfg.range/2));
    const sum = r + s, prod = r * s;
    const steps = [
      `Given x^2 + ${sum}x + ${prod}.`,
      `Find numbers adding to ${sum} and multiplying to ${prod}: ${r} and ${s}.`
    ];
    return { prompt: styleWrap(style, `Factor x^2 + ${sum}x + ${prod}. Provide the smaller factor.`, {}), answer: Math.min(r,s), steps };
  },

  'Ratios & Proportions': (rng, d, style) => {
    const cfg = diffConf[d];
    const a = rndInt(rng, 2, cfg.range);
    const b = rndInt(rng, 2, cfg.range);
    const k = rndInt(rng, 2, 9);
    const steps = [
      `Ratio ${a}:${b}, scale by ${k}.`,
      `Result: ${a*k}:${b*k}.`
    ];
    return { prompt: styleWrap(style, `Scale the ratio ${a}:${b} by ${k}. Give the first term.`, {}), answer: a*k, steps };
  },

  'Rates': (rng, d, style) => {
    const cfg = diffConf[d];
    const dist = rndInt(rng, 5, cfg.range*2);
    const time = rndInt(rng, 1, Math.max(2, Math.floor(cfg.range/5)));
    const speed = dist / time;
    const steps = [
      `Distance = ${dist} km, Time = ${time} h.`,
      `Speed = distance / time = ${dist}/${time} = ${speed} km/h.`
    ];
    return { prompt: styleWrap(style, `A trip covers ${dist} km in ${time} hours. What is the average speed (km/h)?`, {}), answer: speed, steps };
  },

  'Percentages': (rng, d, style) => {
    const cfg = diffConf[d];
    const base = rndInt(rng, 20, cfg.range*3);
    const pct = rndInt(rng, 5, 60);
    const inc = rndInt(rng, 0,1) ? true : false;
    const result = inc ? base*(1+pct/100) : base*(1-pct/100);
    const steps = [
      `Base = ${base}, Percentage = ${pct}% (${inc ? 'increase' : 'decrease'}).`,
      `Result = ${base} × (1 ${inc?'+':'-'} ${pct}/100) = ${result}.`
    ];
    return { prompt: styleWrap(style, `${inc ? 'Increase' : 'Decrease'} ${base} by ${pct}%. Give the final value.`, {}), answer: result, steps };
  },

  'Geometry': (rng, d, style) => {
    const cfg = diffConf[d];
    const type = choice(rng, ['rectangle-area','triangle-area','circle-circumference','pythagoras']);
    if (type === 'rectangle-area') {
      const w = rndInt(rng, 2, cfg.range);
      const h = rndInt(rng, 2, cfg.range);
      const area = w*h;
      const steps = [`Area = width × height = ${w}×${h} = ${area}.`];
      return { prompt: styleWrap(style, `A rectangle has width ${w} and height ${h}. Find its area.`, {}), answer: area, steps };
    }
    if (type === 'triangle-area') {
      const b = rndInt(rng, 2, cfg.range);
      const h = rndInt(rng, 2, cfg.range);
      const area = 0.5*b*h;
      const steps = [`Area = 1/2 × base × height = 0.5×${b}×${h} = ${area}.`];
      return { prompt: styleWrap(style, `A triangle has base ${b} and height ${h}. Find its area.`, {}), answer: area, steps };
    }
    if (type === 'circle-circumference') {
      const r = rndInt(rng, 2, Math.floor(cfg.range/2));
      const C = 2*Math.PI*r;
      const steps = [`Circumference = 2πr = 2π×${r} = ${C.toFixed(4)}.`];
      return { prompt: styleWrap(style, `Find the circumference of a circle with radius ${r}. Use π ≈ ${Math.PI.toFixed(3)}.`, {}), answer: Number(C.toFixed(4)), steps };
    }
    // pythagoras
    const a = rndInt(rng, 3, Math.floor(cfg.range/2));
    const b = rndInt(rng, 4, Math.floor(cfg.range/2));
    const c = Math.sqrt(a*a + b*b);
    const steps = [`c = √(a^2 + b^2) = √(${a}^2 + ${b}^2) = ${c.toFixed(4)}.`];
    return { prompt: styleWrap(style, `Right triangle with legs ${a} and ${b}. Find the hypotenuse length.`, {}), answer: Number(c.toFixed(4)), steps };
  },

  'Probability': (rng, d, style) => {
    const cfg = diffConf[d];
    const red = rndInt(rng, 1, Math.floor(cfg.range/3));
    const blue = rndInt(rng, 1, Math.floor(cfg.range/3));
    const total = red + blue;
    const probRed = red / total;
    const steps = [`P(red) = red/total = ${red}/${total} = ${probRed}.`];
    return { prompt: styleWrap(style, `A bag has ${red} red and ${blue} blue balls. What is the probability of drawing red?`, {}), answer: probRed, steps };
  },

  'Statistics': (rng, d, style) => {
    const cfg = diffConf[d];
    const n = rndInt(rng, 4, 6 + Math.floor(cfg.steps));
    const arr = Array.from({length:n}, () => rndInt(rng, 1, cfg.range));
    const mean = arr.reduce((a,b)=>a+b,0) / n;
    const sorted = arr.slice().sort((a,b)=>a-b);
    const median = n%2 ? sorted[(n-1)/2] : (sorted[n/2-1]+sorted[n/2])/2;
    const ask = choice(rng, ['mean','median']);
    const steps = ask==='mean' ? [
      `Data: [${arr.join(', ')}], n=${n}.`,
      `Mean = sum/n = ${arr.reduce((a,b)=>a+b,0)}/${n} = ${mean}.`
    ] : [
      `Data sorted: [${sorted.join(', ')}], n=${n}.`,
      `Median = middle value(s) → ${median}.`
    ];
    const prompt = ask==='mean' ? `Compute the mean of [${arr.join(', ')}].` : `Compute the median of [${arr.join(', ')}].`;
    return { prompt: styleWrap(style, prompt, {}), answer: ask==='mean' ? mean : median, steps };
  },

  'Number Theory': (rng, d, style) => {
    const cfg = diffConf[d];
    const n = rndInt(rng, 10, cfg.range*2);
    const task = choice(rng, ['gcd','lcm','prime-check']);
    if (task === 'gcd') {
      const m = rndInt(rng, 10, cfg.range*2);
      const G = gcd(n,m);
      const steps = [`Use Euclidean algorithm on (${n},${m}). GCD = ${G}.`];
      return { prompt: styleWrap(style, `Find gcd(${n}, ${m}).`, {}), answer: G, steps };
    }
    if (task === 'lcm') {
      const m = rndInt(rng, 4, cfg.range);
      const G = gcd(n,m);
      const L = Math.abs(n*m)/G;
      const steps = [`LCM = |nm| / gcd(n,m) = |${n}×${m}|/${G} = ${L}.`];
      return { prompt: styleWrap(style, `Find lcm(${n}, ${m}).`, {}), answer: L, steps };
    }
    // prime check (answer: 1 if prime else 0)
    const isPrime = (x)=> {
      if (x<2) return false;
      for (let i=2;i*i<=x;i++) if (x%i===0) return false;
      return true;
    };
    const prime = isPrime(n);
    const steps = [`Check divisibility up to √${n}. Result: ${prime ? 'prime' : 'composite'}.`];
    return { prompt: styleWrap(style, `Is ${n} prime? Answer 1 for prime, 0 for composite.`, {}), answer: prime ? 1 : 0, steps };
  },

  'Sequences & Series': (rng, d, style) => {
    const cfg = diffConf[d];
    const a1 = rndInt(rng, 1, cfg.range);
    const r = rndInt(rng, 1, Math.max(2, Math.floor(cfg.range/5)));
    const type = choice(rng, ['arithmetic-n','arithmetic-sum','geometric-n','geometric-sum']);
    if (type === 'arithmetic-n') {
      const n = rndInt(rng, 4, 10 + cfg.steps);
      const term = a1 + (n-1)*r;
      const steps = [`a_n = a_1 + (n-1)r = ${a1} + (${n-1})×${r} = ${term}.`];
      return { prompt: styleWrap(style, `Arithmetic sequence: a1=${a1}, r=${r}. Find a_${n}.`, {}), answer: term, steps };
    }
    if (type === 'arithmetic-sum') {
      const n = rndInt(rng, 4, 10 + cfg.steps);
      const an = a1 + (n-1)*r;
      const S = n*(a1+an)/2;
      const steps = [`S_n = n(a_1+a_n)/2 = ${n}(${a1}+${an})/2 = ${S}.`];
      return { prompt: styleWrap(style, `Arithmetic seq: a1=${a1}, r=${r}. Find S_${n}.`, {}), answer: S, steps };
    }
    if (type === 'geometric-n') {
      const n = rndInt(rng, 3, 8 + cfg.steps);
      const term = a1 * Math.pow(r, n-1);
      const steps = [`a_n = a_1 r^{n-1} = ${a1}×${r}^{${n-1}} = ${term}.`];
      return { prompt: styleWrap(style, `Geometric sequence: a1=${a1}, r=${r}. Find a_${n}.`, {}), answer: term, steps };
    }
    const n = rndInt(rng, 3, 8 + cfg.steps);
    const S = a1 * (Math.pow(r,n)-1) / (r-1);
    const steps = [`S_n = a_1 (r^n - 1)/(r - 1) = ${a1}((-${1}) + ...)`, `Compute: ${S}.`];
    return { prompt: styleWrap(style, `Geometric seq: a1=${a1}, r=${r}. Find S_${n}.`, {}), answer: S, steps };
  },

  'Functions': (rng, d, style) => {
    const cfg = diffConf[d];
    const a = rndInt(rng, 1, Math.max(2, Math.floor(cfg.range/5)));
    const b = rndInt(rng, -cfg.range, cfg.range);
    const x = rndInt(rng, 1, cfg.range);
    const fx = a*x + b;
    const steps = [`f(x) = ${a}x + ${b}. Evaluate f(${x}) = ${fx}.`];
    return { prompt: styleWrap(style, `Let f(x) = ${a}x + ${b}. Compute f(${x}).`, {}), answer: fx, steps };
  },

  'Linear Equations': (rng, d, style) => {
    const cfg = diffConf[d];
    const A = rndInt(rng, 1, cfg.range), B = rndInt(rng, -cfg.range, cfg.range), C = rndInt(rng, -cfg.range, cfg.range);
    const sol = (C - B) / A;
    const steps = [
      `Solve Ax + B = C.`,
      `x = (C - B)/A = (${C} - ${B})/${A} = ${sol}.`
    ];
    return { prompt: styleWrap(style, `Solve ${A}x + ${B} = ${C} for x.`, {}), answer: sol, steps };
  },

  'Systems of Equations': (rng, d, style) => {
    const cfg = diffConf[d];
    const a1=rndInt(rng,1,Math.max(2,Math.floor(cfg.range/5)));
    const b1=rndInt(rng,1,Math.max(2,Math.floor(cfg.range/5)));
    const c1=rndInt(rng,-cfg.range,cfg.range);
    const a2=rndInt(rng,1,Math.max(2,Math.floor(cfg.range/5)));
    const b2=rndInt(rng,1,Math.max(2,Math.floor(cfg.range/5)));
    const c2=rndInt(rng,-cfg.range,cfg.range);
    const det = a1*b2 - a2*b1;
    // Ensure solvable unique solution
    if (det === 0) return Generators['Systems of Equations'](rng, d, style);
    const x = (c1*b2 - c2*b1)/det;
    const y = (a1*c2 - a2*c1)/det;
    const steps = [
      `System: ${a1}x + ${b1}y = ${c1}; ${a2}x + ${b2}y = ${c2}.`,
      `Determinant Δ = ${det}.`,
      `x = (c1*b2 - c2*b1)/Δ = ${x}.`,
      `y = (a1*c2 - a2*c1)/Δ = ${y}.`
    ];
    return { prompt: styleWrap(style, `Solve the system: ${a1}x + ${b1}y = ${c1}, ${a2}x + ${b2}y = ${c2}. Give x.`, {}), answer: x, steps };
  },

  'Exponents & Radicals': (rng, d, style) => {
    const cfg = diffConf[d];
    const base = rndInt(rng, 2, Math.max(3, Math.floor(cfg.range/5)));
    const exp = rndInt(rng, 2, 6 + Math.floor(cfg.steps));
    const type = choice(rng, ['power','root']);
    if (type === 'power') {
      const val = Math.pow(base, exp);
      const steps = [`Compute ${base}^${exp} = ${val}.`];
      return { prompt: styleWrap(style, `Compute ${base}^${exp}.`, {}), answer: val, steps };
    }
    const n = rndInt(rng, 2, Math.max(3, Math.floor(cfg.range/6)));
    const val = Math.pow(base, n);
    const root = Math.sqrt(val);
    const steps = [`Given √(${val}) = √(${base}^${n} × ${base}^${n}) = ${root}.`];
    return { prompt: styleWrap(style, `Compute √(${val}).`, {}), answer: root, steps };
  }
};

/* ===== Combination count (lower-bound estimate) ===== */
function estimateCombinations() {
  // Rough lower bound: sum of templates × parameter ranges × difficulties × styles
  const templatesPerBranch = {
    'Arithmetic': 4, 'Algebra': 3, 'Ratios & Proportions': 1, 'Rates': 1, 'Percentages': 1,
    'Geometry': 4, 'Probability': 1, 'Statistics': 2, 'Number Theory': 3, 'Sequences & Series': 4,
    'Functions': 1, 'Linear Equations': 1, 'Systems of Equations': 1, 'Exponents & Radicals': 2
  };
  const paramMultiplier = 40; // conservative multiplier for parameter ranges across difficulties
  let totalTemplates = 0;
  for (const b of Object.keys(templatesPerBranch)) totalTemplates += templatesPerBranch[b];
  // branches × templates × difficulties × styles × parameters
  const combos = branches.length * totalTemplates * difficulties.length * styles.length * paramMultiplier;
  return combos;
}

/* ===== Rendering and interactions ===== */
function setSeed(str) {
  const s = str && str.trim() ? str.trim() : `MATH-${Date.now()}-${Math.floor(Math.random()*1e6)}`;
  state.seed = s;
  state.rng = makeRNG(hashSeed(s));
  document.getElementById('seedDisplay').textContent = s;
  document.getElementById('seed').value = s;
}

function readControls() {
  state.branch = document.getElementById('branch').value;
  state.difficulty = document.getElementById('difficulty').value;
  state.style = document.getElementById('style').value;
  const sd = document.getElementById('seed').value.trim();
  if (sd) setSeed(sd);
  else if (!state.seed) setSeed(null);
}

function generateProblem() {
  readControls();
  const gen = Generators[state.branch];
  const out = gen(state.rng, state.difficulty, state.style);
  state.current = out;
  const meta = `${state.branch} • ${state.difficulty.toUpperCase()} • ${state.style}`;
  document.getElementById('meta').textContent = meta;
  document.getElementById('problem').textContent = out.prompt;
  document.getElementById('solution').style.display = 'none';
  document.getElementById('solution').textContent = out.steps.join('\n');
  document.getElementById('feedback').textContent = '';
  document.getElementById('answer').value = '';
}

function checkAnswer() {
  const user = parseAnswer(document.getElementById('answer').value);
  if (user === null) {
    document.getElementById('feedback').textContent = 'Enter a valid number/fraction/percent.';
    return;
  }
  const ans = state.current?.answer;
  let ok;
  // If answer is integer, require exact; else allow tolerance.
  if (Number.isInteger(ans)) ok = (user === ans);
  else ok = approxEqual(user, ans, 1e-4);
  document.getElementById('feedback').innerHTML = ok ? '<span class="ok">Correct!</span>' : '<span class="no">Not quite.</span>';
}

function randomizeOptions() {
  const rng = state.rng || makeRNG(hashSeed(String(Date.now())));
  document.getElementById('branch').value = choice(rng, branches);
  document.getElementById('difficulty').value = choice(rng, difficulties);
  document.getElementById('style').value = choice(rng, styles);
}

function showSolution() {
  document.getElementById('solution').style.display = 'block';
}

function newProblemSameSettings() {
  // advance RNG by tweaking seed increment
  setSeed(state.seed + '-N' + Math.floor(Math.random()*1000));
  generateProblem();
}

function copyLink() {
  const params = new URLSearchParams({
    branch: state.branch,
    difficulty: state.difficulty,
    style: state.style,
    seed: state.seed
  });
  const url = `${location.origin}${location.pathname}?${params.toString()}`;
  navigator.clipboard.writeText(url).then(()=>{
    document.getElementById('feedback').textContent = 'Link copied.';
  });
}

/* Query param bootstrapping */
function bootFromURL() {
  const q = new URLSearchParams(location.search);
  const branch = q.get('branch');
  const difficulty = q.get('difficulty');
  const style = q.get('style');
  const seed = q.get('seed');
  if (branch && branches.includes(branch)) document.getElementById('branch').value = branch;
  if (difficulty && difficulties.includes(difficulty)) document.getElementById('difficulty').value = difficulty;
  if (style && styles.includes(style)) document.getElementById('style').value = style;
  setSeed(seed || null);
}

/* Init */
document.addEventListener('DOMContentLoaded', ()=>{
  bootFromURL();
  const combos = estimateCombinations();
  document.getElementById('comboCount').textContent = `Estimated unique combinations: ${combos.toLocaleString()}+`;
  document.getElementById('generate').addEventListener('click', generateProblem);
  document.getElementById('check').addEventListener('click', checkAnswer);
  document.getElementById('randomize').addEventListener('click', ()=>{
    randomizeOptions(); generateProblem();
  });
  document.getElementById('showSolution').addEventListener('click', showSolution);
  document.getElementById('newProblem').addEventListener('click', newProblemSameSettings);
  document.getElementById('copyLink').addEventListener('click', copyLink);
  document.getElementById('newSeed').addEventListener('click', ()=>{ setSeed(null); });
});
</script>
</body>
</html>
