<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dynamic Maths Problem Generator</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #22d3ee;
      --accent2: #a78bfa;
      --danger: #ef4444;
      --ok: #10b981;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: linear-gradient(120deg, #0f172a, #111827);
      color: var(--text);
    }
    header { padding: 24px; text-align: center; }
    header h1 { margin: 0; font-size: 1.8rem; letter-spacing: 0.3px; }
    header p { margin: 8px 0 0; color: var(--muted); }
    main { max-width: 1000px; margin: 0 auto; padding: 24px; }
    .panel {
      background: rgba(17,24,39,0.75);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 16px;
      padding: 20px;
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .grid { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    label { font-weight: 600; color: var(--text); display: block; margin-bottom: 8px; }
    select, input[type="text"] {
      width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.12);
      background: #0b1220; color: var(--text);
    }
    .controls { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 14px; }
    button {
      padding: 10px 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color: #0b1220; font-weight: 700; cursor: pointer;
    }
    button.secondary {
      background: #0b1220; color: var(--text); border: 1px solid rgba(255,255,255,0.12);
    }
    .problem {
      margin-top: 20px; padding: 16px; border-radius: 12px; background: #0b1220; border: 1px solid rgba(255,255,255,0.08);
    }
    .meta { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 8px; color: var(--muted); font-size: 0.9rem; }
    .badge { padding: 4px 8px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.12); }
    pre, code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .hint, .solution { margin-top: 12px; background: #0f172a; padding: 12px; border-radius: 8px; border: 1px dashed rgba(255,255,255,0.12); }
    .foot { margin-top: 18px; color: var(--muted); font-size: 0.85rem; }
    a { color: var(--accent); }
  </style>
</head>
<body>
  <header>
    <h1>Dynamic Maths Problem Generator</h1>
    <p>Five difficulties, many branches, styles, and real word problems. Seeded randomness for reproducible generation.</p>
  </header>
  <main>
    <div class="panel">
      <div class="grid">
        <div>
          <label for="difficulty">Difficulty</label>
          <select id="difficulty">
            <option value="easy">Primary</option>
            <option value="medium">Year 7-8</option>
            <option value="hard">Year 9-10</option>
            <option value="harder">Year 11-12</option>
            <option value="EXTREME">University</option>
            <option value="PhD">PhD</option>
          </select>
        </div>
        <div>
          <label for="branch">Branch</label>
          <select id="branch">
            <option>arithmetic</option>
            <option>algebra</option>
            <option>ratios</option>
            <option>rates</option>
            <option>percentages</option>
            <option>probability</option>
            <option>geometry</option>
            <option>sequences</option>
            <option>exponents</option>
            <option>inequalities</option>
            <option>statistics</option>
            <option>mixed</option>
          </select>
        </div>
        <div>
          <label for="style">Problem style</label>
          <select id="style">
            <option>normal</option>
            <option>word problem</option>
            <option>problem solving problem</option>
          </select>
        </div>
        <div>
          <label for="seed">Seed (optional for reproducibility)</label>
          <input id="seed" type="text" placeholder="auto-generated each click; or enter a number/text"/>
        </div>
      </div>
      <div class="controls">
        <button id="generateBtn">Generate</button>
        <button id="copyBtn" class="secondary">Copy problem</button>
        <button id="shareBtn" class="secondary">Share URL with seed</button>
      </div>

      <div class="problem" id="problemBox" aria-live="polite">
        <div id="problemText">Pick options and click Generate.</div>
        <div class="meta" id="meta"></div>
        <div class="hint" id="hint"></div>
        <div class="solution" id="solution"></div>
      </div>

      <div class="foot">
        Tip: Add <code>?seed=yourvalue</code> to the URL to reproduce a problem. Extend branches or templates in the code to grow combinations.
      </div>
    </div>
  </main>

<script>
/* ========= Seeded RNG ========= */
function xmur3(str) {
  let h = 1779033703 ^ str.length;
  for (let i = 0; i < str.length; i++) {
    h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
    h = (h << 13) | (h >>> 19);
  }
  return function() {
    h = Math.imul(h ^ (h >>> 16), 2246822507);
    h = Math.imul(h ^ (h >>> 13), 3266489909);
    h ^= h >>> 16;
    return h >>> 0;
  };
}
function sfc32(a, b, c, d) {
  return function() {
    a >>>= 0; b >>>= 0; c >>>= 0; d >>>= 0;
    let t = (a + b) | 0;
    a = b ^ (b >>> 9);
    b = (c + (c << 3)) | 0;
    c = (c << 21) | (c >>> 11);
    c = (c + t) | 0;
    d = (d + 1) | 0;
    t = (t + d) | 0;
    c = (c + t) | 0;
    return (t >>> 0) / 4294967296;
  };
}
function makeRng(seedStr) {
  const seed = xmur3(seedStr);
  return sfc32(seed(), seed(), seed(), seed());
}
function randInt(rng, min, max) { // inclusive
  return Math.floor(rng() * (max - min + 1)) + min;
}
function choice(rng, arr) { return arr[Math.floor(rng() * arr.length)]; }

/* ========= Difficulty configs ========= */
const DIFFS = {
  easy:    { range: 10,   ops: 2,  steps: 1 },
  medium:  { range: 30,   ops: 3,  steps: 2 },
  hard:    { range: 80,   ops: 4,  steps: 2 },
  harder:  { range: 200,  ops: 5,  steps: 3 },
  EXTREME: { range: 1000, ops: 6,  steps: 4 },
  PhD:     { range: 5000, ops: 8,  steps: 5 }
};

/* ========= Names and contexts ========= */
const names = ["Jack","Maya","Omar","Priya","Noah","Zoe","Liam","Ava","Kai","Ella","Hana","Tom"];
const contexts = {
  workshop: { items: "logs", people: "people", place: "workshop" },
  bakery:   { items: "baguettes", people: "bakers", place: "bakery" },
  farm:     { items: "hay bales", people: "farmhands", place: "farm" },
  lab:      { items: "samples", people: "researchers", place: "lab" },
  class:    { items: "worksheets", people: "students", place: "classroom" },
  warehouse:{ items: "crates", people: "workers", place: "warehouse" },
  kitchen:  { items: "ingredients", people: "chefs", place: "kitchen" },
  library:  { items: "books", people: "librarians", place: "library" },
  gym:      { items: "weights", people: "trainers", place: "gym" }
};

/* ========= Branch templates ========= */
const Branches = {
  arithmetic: {
    normal: (rng, diff) => {
      const a = randInt(rng, 1, diff.range);
      const b = randInt(rng, 1, diff.range);
      const c = randInt(rng, 1, diff.range);
      const ops = choice(rng, ["+","-","×","÷"]);
      const ops2 = choice(rng, ["+","-","×","÷"]);
      const expr = `(${a} ${ops} ${b}) ${ops2} ${c}`;
      return {
        text: `Compute ${expr}.`,
        hint: `Evaluate inside parentheses first.`,
        solution: `Work left to right respecting precedence for × and ÷.`
      };
    },
    // --- MODIFIED: 'word' is now an array of templates ---
    word: [
      (rng, diff) => { // Template 1: Packing
        const ctx = choice(rng, Object.values(contexts));
        const n = randInt(rng, 3, diff.range + 3);
        const m = randInt(rng, 2, Math.max(4, Math.floor(n/2)));
        return {
          text: `${choice(rng,names)} is at a ${ctx.place} with ${n} ${ctx.items}. They pack ${m} per box. How many boxes are needed?`,
          hint: `Divide total items by items per box.`,
          solution: `Boxes = ${n} ÷ ${m}. If not divisible, round up.`
        };
      },
      (rng, diff) => { // Template 2: Total Cost
        const ctx = choice(rng, Object.values(contexts));
        const n1 = randInt(rng, 2, diff.range + 2);
        const p1 = randInt(rng, 1, diff.range + 5);
        const n2 = randInt(rng, 2, diff.range + 2);
        const p2 = randInt(rng, 1, diff.range + 5);
        return {
          text: `${choice(rng,names)} is at the ${ctx.place} and buys ${n1} ${ctx.items} at $${p1} each and ${n2} other ${ctx.items} at $${p2} each. What is the total cost?`,
          hint: `Total cost = (quantity 1 × price 1) + (quantity 2 × price 2).`,
          solution: `Total = (${n1} × ${p1}) + (${n2} × ${p2}).`
        };
      },
      (rng, diff) => { // Template 3: Multi-step change
        const ctx = choice(rng, Object.values(contexts));
        const start = randInt(rng, 10, diff.range + 10);
        const gave = randInt(rng, 2, Math.floor(start / 2));
        const received = randInt(rng, 2, diff.range);
        return {
          text: `In the ${ctx.place}, ${choice(rng,names)} starts with ${start} ${ctx.items}. They give ${gave} to a friend and then receive ${received} more. How many ${ctx.items} do they have now?`,
          hint: `Start with the initial amount, subtract the amount given, and add the amount received.`,
          solution: `Final = ${start} - ${gave} + ${received}.`
        };
      }
    ],
    solving: (rng, diff) => {
      const target = randInt(rng, 20, diff.range + 40);
      const a = randInt(rng, 1, diff.range); const b = randInt(rng, 1, diff.range);
      return {
        text: `Find two numbers whose sum is ${target} and product is ${a*b}. Provide one possible pair.`,
        hint: `Start from factors of ${a*b} and check sums.`,
        solution: `List factor pairs and test the sum equals ${target}.`
      };
    }
  },

  algebra: {
    normal: (rng, diff) => {
      const p = randInt(rng, 2, 9), q = randInt(rng, 1, 9);
      const r = randInt(rng, 1, 20);
      return {
        text: `Solve for x: ${p}x + ${q} = ${r}.`,
        hint: `Isolate x by subtracting ${q}, then divide by ${p}.`,
        solution: `x = (${r} - ${q}) ÷ ${p}.`
      };
    },
    word: [
      (rng, diff) => { // Template 1: Rate of addition
        const name = choice(rng, names);
        const ctx = choice(rng, Object.values(contexts));
        const x = randInt(rng, 2, 9); // items per hour
        const y = randInt(rng, 5, 20); // starting items
        const h = randInt(rng, 2, 5); // hours
        const total = y + x * h;
        return {
          text: `${name} is at the ${ctx.place} which starts with ${y} ${ctx.items}. ${name} adds ${x} ${ctx.items} per hour. The total T is given by T = ${y} + ${x}h, where h is hours. How many hours has it been if the total is now ${total}?`,
          hint: `Solve for h in ${total} = ${y} + ${x}h.`,
          solution: `h = (${total} - ${y}) / ${x}.`
        };
      },
      (rng, diff) => { // Template 2: Perimeter
        const ctx = choice(rng, Object.values(contexts));
        const l = randInt(rng, 5, diff.range + 10);
        const w = randInt(rng, 5, diff.range + 10);
        const p = 2 * (l + w);
        return {
          text: `A rectangular ${ctx.place} has a perimeter of ${p} meters. The length is ${l} meters. Let the width be 'w'. Given P = 2(l + w), find the width.`,
          hint: `Substitute the known values into the formula ${p} = 2(${l} + w) and solve for w.`,
          solution: `Divide by 2: ${p/2} = ${l} + w. Then subtract ${l}: w = ${p/2} - ${l}.`
        };
      },
      (rng, diff) => { // Template 3: Cost
        const name = choice(rng, names);
        const ctx = choice(rng, Object.values(contexts));
        const x = randInt(rng, 3, diff.range + 3);
        const p = randInt(rng, 2, diff.range);
        const t = x * p;
        return {
          text: `${name} buys ${x} ${ctx.items} at the ${ctx.place}. The total cost was $${t}. If each item costs '$p', solve for 'p'.`,
          hint: `Total cost = quantity × price. So, ${t} = ${x} × p.`,
          solution: `p = ${t} / ${x}.`
        };
      }
    ],
    solving: (rng, diff) => {
      const a = randInt(rng, 2, 8), b = randInt(rng, 1, 9), c = randInt(rng, 1, 12);
      return {
        text: `Solve: ${a}(x - ${b}) = ${c}.`,
        hint: `Expand or divide both sides by ${a}.`,
        solution: `x - ${b} = ${c} ÷ ${a} ⇒ x = ${b} + (${c} ÷ ${a}).`
      };
    }
  },

  ratios: {
    normal: (rng, diff) => {
      const a = randInt(rng, 2, 12), b = randInt(rng, 2, 12), scale = randInt(rng, 2, 10);
      return {
        text: `A ratio ${a}:${b} is scaled by ${scale}. What is the new ratio?`,
        hint: `Multiply both parts by ${scale}.`,
        solution: `${a*scale}:${b*scale}.`
      };
    },
    word: [
      (rng, diff) => { // Template 1: People to Items
        const ctx = choice(rng, Object.values(contexts));
        const items = randInt(rng, 10, diff.range+10), people = randInt(rng, 2, 12);
        return {
          text: `${choice(rng,names)} is at a ${ctx.place} with ${items} ${ctx.items} and ${people} ${ctx.people}. What is the ratio of ${ctx.people} to ${ctx.items}?`,
          hint: `Write people:items and simplify.`,
          solution: `Ratio = ${people}:${items}, then reduce by GCD.`
        };
      },
      (rng, diff) => { // Template 2: Recipe
        const ctx = contexts.kitchen;
        const a = randInt(rng, 2, 10);
        const b = randInt(rng, 2, 10);
        const n = randInt(rng, 12, 48);
        return {
          text: `In the ${ctx.place}, a recipe for ${n} ${ctx.items} requires ${a} parts flour and ${b} parts sugar. What is the simplified ratio of flour to sugar?`,
          hint: `Write the ratio as flour:sugar and simplify by dividing by the greatest common divisor.`,
          solution: `Ratio = ${a}:${b}. Find GCD(${a}, ${b}) and divide both parts.`
        };
      },
      (rng, diff) => { // Template 3: Sharing
        const name1 = choice(rng, names);
        let name2 = choice(rng, names);
        while (name1 === name2) name2 = choice(rng, names); // Ensure names are different
        const ctx = choice(rng, Object.values(contexts));
        const a = randInt(rng, 2, 9);
        const b = randInt(rng, 2, 9);
        const total = (a + b) * randInt(rng, 3, diff.range);
        return {
          text: `${name1} and ${name2} share ${total} ${ctx.items} from the ${ctx.place} in the ratio ${a}:${b}. How many items does ${name1} get?`,
          hint: `The total number of parts is ${a+b}. ${name1}'s share is (a / (a+b)) of the total.`,
          solution: `${name1}'s items = ${total} × ${a} / (${a+b}).`
        };
      }
    ],
    solving: (rng, diff) => {
      const a = randInt(rng, 2, 9), b = randInt(rng, 2, 9), total = randInt(rng, 30, 300);
      return {
        text: `In ratio ${a}:${b}, the total is ${total}. How much is the first part?`,
        hint: `Sum parts: ${a+b}. First = total × a/(a+b).`,
        solution: `First = ${total} × ${a} / (${a+b}).`
      };
    }
  },

  rates: {
    normal: (rng, diff) => {
      const dist = randInt(rng, 10, diff.range+50), speed = randInt(rng, 10, 120);
      return {
        text: `Traveling at ${speed} km/h for distance ${dist} km, how long does it take?`,
        hint: `Time = distance ÷ speed.`,
        solution: `t = ${dist} ÷ ${speed} hours.`
      };
    },
    word: [
      (rng, diff) => { // Template 1: Group Work
        const ctx = choice(rng, Object.values(contexts));
        const numItems = randInt(rng, 20, diff.range+50);
        const people = randInt(rng, 2, 15);
        const rate = randInt(rng, 1, 5);
        return {
          text: `${choice(rng,names)} is at a ${ctx.place} with ${numItems} ${ctx.items} and ${people} ${ctx.people}. Each person processes ${rate} ${ctx.items} per hour. How many hours to finish?`,
          hint: `Total rate = people × ${ctx.items}/hour.`,
          solution: `Time = ${numItems} ÷ (${people} × ${rate}).`
        };
      },
      (rng, diff) => { // Template 2: Speed/Distance/Time
        const name = choice(rng, names);
        const d = randInt(rng, 20, diff.range + 100);
        const s = randInt(rng, 10, 120);
        return {
          text: `${name} travels ${d} km at an average speed of ${s} km/h. How long (in hours) did the journey take?`,
          hint: `Time = Distance / Speed.`,
          solution: `Time = ${d} / ${s} hours.`
        };
      },
      (rng, diff) => { // Template 3: Fill Rate
        const ctx = contexts.lab;
        const r = randInt(rng, 5, 50);
        const V = randInt(rng, 100, diff.range + 100);
        return {
          text: `A ${ctx.place} machine fills ${ctx.items} at a rate of ${r} mL per minute. How long will it take to fill a ${V} mL container?`,
          hint: `Time = Total Volume / Rate.`,
          solution: `Time = ${V} / ${r} minutes.`
        };
      }
    ],
    solving: (rng, diff) => {
      const a = randInt(rng, 30, 200), b = randInt(rng, 1, 6);
      return {
        text: `A machine makes ${a} units in ${b} hours at constant rate. How many in t hours? Express as function f(t).`,
        hint: `Rate = units per hour.`,
        solution: `f(t) = (${a}/${b}) t.`
      };
    }
  },

  percentages: {
    normal: (rng, diff) => {
      const base = randInt(rng, 50, diff.range+200), pct = randInt(rng, 5, 60);
      return {
        text: `Increase ${base} by ${pct}%. What is the new value?`,
        hint: `New = base × (1 + pct/100).`,
        solution: `New = ${base} × (1 + ${pct}/100).`
      };
    },
    word: [
      (rng, diff) => { // Template 1: Discount
        const name = choice(rng, names), price = randInt(rng, 20, 200), disc = randInt(rng, 10, 50);
        return {
          text: `${name} buys a tool priced at $${price} with a ${disc}% discount. What is the final price?`,
          hint: `Final = price × (1 - disc/100).`,
          solution: `Final = ${price} × (1 - ${disc}/100).`
        };
      },
      (rng, diff) => { // Template 2: Tax
        const name = choice(rng, names);
        const ctx = choice(rng, Object.values(contexts));
        const price = randInt(rng, 10, diff.range + 10);
        const tax = randInt(rng, 5, 20);
        return {
          text: `${name} buys ${ctx.items} from the ${ctx.place} for $${price}. A sales tax of ${tax}% is added. What is the total cost?`,
          hint: `Total = price × (1 + tax/100).`,
          solution: `Total = ${price} × (1 + ${tax}/100).`
        };
      },
      (rng, diff) => { // Template 3: Percent Change
        const ctx = choice(rng, Object.values(contexts));
        const start = randInt(rng, 50, diff.range + 50);
        const end = randInt(rng, start + 10, start + 100);
        return {
          text: `The number of ${ctx.items} in the ${ctx.place} increased from ${start} to ${end}. What was the percentage increase?`,
          hint: `Percent change = ((New - Old) / Old) × 100.`,
          solution: `((${end} - ${start}) / ${start}) × 100%.`
        };
      }
    ],
    solving: (rng, diff) => {
      const start = randInt(rng, 60, 300), end = randInt(rng, 60, 500);
      return {
        text: `The value changes from ${start} to ${end}. What percent change is this?`,
        hint: `Percent change = ((end - start)/start) × 100%.`,
        solution: `((${end} - ${start}) / ${start}) × 100%.`
      };
    }
  },

  probability: {
    normal: (rng, diff) => {
      const red = randInt(rng, 1, 10), blue = randInt(rng, 1, 10);
      return {
        text: `A bag has ${red} red and ${blue} blue balls. Probability of drawing red?`,
        hint: `Favorable/Total.`,
        solution: `${red} / (${red + blue}).`
      };
    },
    word: [
      (rng, diff) => { // Template 1: Quiz
        const ctx = contexts.class;
        const correct = randInt(rng, 5, 20), wrong = randInt(rng, 2, 10);
        return {
          text: `In a ${ctx.place} quiz with ${correct} true and ${wrong} false statements shuffled, what is the probability a random pick is true?`,
          hint: `True over total.`,
          solution: `${correct} / (${correct + wrong}).`
        };
      },
      (rng, diff) => { // Template 2: Items in a bag
        const ctx = choice(rng, Object.values(contexts));
        const name = choice(rng, names);
        const a = randInt(rng, 2, diff.range);
        const b = randInt(rng, 2, diff.range);
        return {
          text: `A bag in the ${ctx.place} contains ${a} red ${ctx.items} and ${b} blue ${ctx.items}. ${name} picks one at random. What is the probability it is red?`,
          hint: `Probability = (Number of red items) / (Total number of items).`,
          solution: `P(Red) = ${a} / (${a} + ${b}).`
        };
      },
      (rng, diff) => { // Template 3: Dice
        const name = choice(rng, names);
        return {
          text: `${name} rolls a standard 6-sided die. What is the probability of rolling an even number?`,
          hint: `Count the even-numbered faces (2, 4, 6) and divide by the total number of faces.`,
          solution: `There are 3 even faces (2, 4, 6) and 6 total faces. P(Even) = 3 / 6 = 1/2.`
        };
      }
    ],
    solving: (rng, diff) => {
      const n = randInt(rng, 4, 10);
      return {
        text: `Roll a fair die ${n} times. Probability of at least one 6?`,
        hint: `Complement: 1 - P(no 6).`,
        solution: `1 - (5/6)^${n}.`
      };
    }
  },

  geometry: {
    normal: (rng, diff) => {
      const l = randInt(rng, 2, diff.range/2 + 10), w = randInt(rng, 2, diff.range/2 + 10);
      return {
        text: `Rectangle with length ${l} and width ${w}. Find area and perimeter.`,
        hint: `Area = l×w; Perimeter = 2(l+w).`,
        solution: `A = ${l*w}, P = ${2*(l+w)}.`
      };
    },
    word: [
      (rng, diff) => { // Template 1: Square Frames
        const wood = randInt(rng, 4, 20), plank = randInt(rng, 2, 10);
        return {
          text: `A carpenter makes square frames using ${wood} m of wood per frame. If each side uses ${plank} m, how many frames can be made?`,
          hint: `Per frame wood = 4×side length.`,
          solution: `Frames = floor(${wood} ÷ (4×${plank})).`
        };
      },
      (rng, diff) => { // Template 2: Area
        const ctx = choice(rng, [contexts.farm, contexts.class, contexts.workshop]);
        const l = randInt(rng, 5, diff.range + 5);
        const w = randInt(rng, 5, diff.range + 5);
        return {
          text: `A rectangular ${ctx.place} has a length of ${l} meters and a width of ${w} meters. What is its total area?`,
          hint: `Area of a rectangle = length × width.`,
          solution: `Area = ${l} × ${w} square meters.`
        };
      },
      (rng, diff) => { // Template 3: Volume
        const ctx = choice(rng, [contexts.warehouse, contexts.lab]);
        const s = randInt(rng, 3, diff.range + 3);
        return {
          text: `A ${ctx.place} stores ${ctx.items} in cubic boxes. If one box has a side length of ${s} cm, what is its volume?`,
          hint: `Volume of a cube = side × side × side (or side³).`,
          solution: `Volume = ${s} × ${s} × ${s} = ${s**3} cubic cm.`
        };
      }
    ],
    solving: (rng, diff) => {
      const r = randInt(rng, 2, 20);
      return {
        text: `Circle radius ${r}. Find circumference and area (use π).`,
        hint: `C = 2πr; A = πr².`,
        solution: `C = 2π×${r}, A = π×${r}².`
      };
    }
  },

  sequences: {
    normal: (rng, diff) => {
      const a1 = randInt(rng, 1, 20), d = randInt(rng, 1, 15), n = randInt(rng, 5, 20);
      return {
        text: `Arithmetic sequence a₁=${a1}, d=${d}. Find aₙ for n=${n}.`,
        hint: `aₙ = a₁ + (n-1)d.`,
        solution: `aₙ = ${a1} + (${n-1})×${d}.`
      };
    },
    word: [
      (rng, diff) => { // Template 1: Stacking
        const start = randInt(rng, 5, 50), step = randInt(rng, 2, 12), term = randInt(rng, 4, 25);
        return {
          text: `A worker stacks crates increasing by ${step} per layer. The bottom layer has ${start}. How many crates on layer ${term} (from the bottom)?`,
          hint: `This is an arithmetic sequence. Use aₙ = a₁ + (n-1)d.`,
          solution: `aₙ = ${start} + (${term-1})×${step}.`
        };
      },
      (rng, diff) => { // Template 2: Saving Money
        const name = choice(rng, names);
        const start = randInt(rng, 10, diff.range + 10);
        const d = randInt(rng, 2, diff.range);
        const n = randInt(rng, 5, 20);
        return {
          text: `${name} saves $${start} in the first week, and $${d} *more* each week than the last. How much will ${name} save in week ${n}?`,
          hint: `Arithmetic sequence: a₁ = ${start}, d = ${d}. Find aₙ.`,
          solution: `aₙ = ${start} + (${n-1})×${d}.`
        };
      },
      (rng, diff) => { // Template 3: Geometric Growth
        const ctx = contexts.lab;
        const a = randInt(rng, 2, 20);
        const r = randInt(rng, 2, 5); // multiplier
        const n = randInt(rng, 3, 10);
        return {
          text: `A ${ctx.place} sample starts with ${a} bacteria. The population multiplies by ${r} every hour. How many bacteria will there be after ${n} hours?`,
          hint: `Geometric sequence: a₁ = ${a}, r = ${r}. Find aₙ (or aₙ₊₁ depending on convention). Let's use N = a * r^n.`,
          solution: `After ${n} hours, N = ${a} × ${r}^${n}. (a₁=${a}r for hour 1, or a₀=${a} for hour 0)`
        };
      }
    ],
    solving: (rng, diff) => {
      const a1 = randInt(rng, 1, 10), r = randInt(rng, 2, 6), n = randInt(rng, 4, 10);
      return {
        text: `Geometric sequence a₁=${a1}, ratio r=${r}. Find Sₙ for n=${n}.`,
        hint: `Sₙ = a₁(1 - rⁿ)/(1 - r), r≠1.`,
        solution: `Sₙ = ${a1}(1 - ${r}^${n})/(1 - ${r}).`
      };
    }
  },

  exponents: {
    normal: (rng, diff) => {
      const a = randInt(rng, 2, 9), b = randInt(rng, 2, 5), c = randInt(rng, 2, 5);
      return {
        text: `Simplify: ${a}^${b} × ${a}^${c}.`,
        hint: `Add exponents with same base.`,
        solution: `${a}^${b+c}.`
      };
    },
    word: [
      (rng, diff) => { // Template 1: Bacteria
        const base = randInt(rng, 2, 5), days = randInt(rng, 3, 8);
        return {
          text: `Bacteria in a ${contexts.lab.place} double each day, starting with ${base} cells. After ${days} days, how many cells?`,
          hint: `Exponential growth: N = N₀·2^t.`,
          solution: `${base} × 2^${days}.`
        };
      },
      (rng, diff) => { // Template 2: Compound Interest
        const name = choice(rng, names);
        const P = randInt(rng, 100, diff.range + 100);
        const r_pct = randInt(rng, 2, 10);
        const r = 1 + (r_pct / 100);
        const t = randInt(rng, 3, 10);
        return {
          text: `${name} invests $${P} at a rate that multiplies by ${r} (a ${r_pct}% increase) each year. What is the value after ${t} years?`,
          hint: `Use the compound interest formula V = P × r^t.`,
          solution: `V = ${P} × (${r})^${t}.`
        };
      },
      (rng, diff) => { // Template 3: Half-life
        const ctx = contexts.lab;
        const A = randInt(rng, 10, 50) * 10;
        const n = randInt(rng, 2, 5);
        const h = randInt(rng, 5, 20);
        return {
          text: `A ${ctx.place} ${ctx.items} has ${A}g of a substance with a half-life of ${h} years. How much will remain after ${n*h} years?`,
          hint: `The time is ${n} half-lives. Use A_final = A_initial × (1/2)^n.`,
          solution: `Final = ${A} × (1/2)^${n} = ${A} / 2^${n}.`
        };
      }
    ],
    solving: (rng, diff) => {
      const a = randInt(rng, 2, 9), k = randInt(rng, 2, 5);
      return {
        text: `Solve for x: ${a}^x = ${a}^${k}.`,
        hint: `Equal bases ⇒ equal exponents.`,
        solution: `x = ${k}.`
      };
    }
  },

  inequalities: {
    normal: (rng, diff) => {
      const p = randInt(rng, 2, 9), q = randInt(rng, 1, 20);
      return {
        text: `Solve: ${p}x + ${q} > ${q + p}.`,
        hint: `Subtract q; divide by p.`,
        solution: `x > ${(q + p - q) / p}.`
      };
    },
    word: [
      (rng, diff) => { // Template 1: Earning
        const hours = randInt(rng, 10, 40), minWage = randInt(rng, 15, 30);
        return {
          text: `A worker earns $w per hour for ${hours} hours. To make at least $${hours*minWage}, what inequality must w satisfy?`,
          hint: `Total pay ≥ target.`,
          solution: `${hours}w ≥ ${hours*minWage} ⇒ w ≥ ${minWage}.`
        };
      },
      (rng, diff) => { // Template 2: Budget
        const name = choice(rng, names);
        const ctx = choice(rng, Object.values(contexts));
        const B = randInt(rng, 50, diff.range + 50);
        const p = randInt(rng, 5, 15);
        return {
          text: `${name} has a budget of $${B} for the ${ctx.place}. They want to buy ${ctx.items} that cost $${p} each. What is the maximum number of ${ctx.items} ('x') they can buy?`,
          hint: `The total cost (p × x) must be less than or equal to the budget (B).`,
          solution: `${p}x ≤ ${B} ⇒ x ≤ ${B / p}. Max items = floor(${B / p}).`
        };
      },
      (rng, diff) => { // Template 3: Temperature
        const ctx = contexts.lab;
        const T1 = randInt(rng, 15, 20);
        const T2 = randInt(rng, 21, 30);
        return {
          text: `The ${ctx.place} ${ctx.items} must be kept above ${T1}°C and below ${T2}°C. Write a compound inequality for the temperature T.`,
          hint: `T must be greater than ${T1} AND less than ${T2}.`,
          solution: `${T1} < T < ${T2}.`
        };
      }
    ],
    solving: (rng, diff) => {
      const a = randInt(rng, 2, 8), b = randInt(rng, 1, 12);
      return {
        text: `Solve: ${a}(x - ${b}) ≤ ${a*b}.`,
        hint: `Divide by ${a}, then add ${b}.`,
        solution: `x - ${b} ≤ ${b} ⇒ x ≤ ${b + b - b}.` // Simplified from original
      };
    }
  },

  statistics: {
    normal: (rng, diff) => {
      const n = randInt(rng, 5, 10);
      const data = Array.from({length: n}, () => randInt(rng, 1, 30));
      const sum = data.reduce((s, v)=>s+v, 0);
      return {
        text: `Data set: [${data.join(", ")}]. Find the mean.`,
        hint: `Mean = sum ÷ count.`,
        solution: `Mean = ${sum} ÷ ${n}.`
      };
    },
    word: [
      (rng, diff) => { // Template 1: Median
        const days = randInt(rng, 5, 7);
        const outputs = Array.from({length: days}, () => randInt(rng, 10, 40));
        return {
          text: `A factory produces units over ${days} days: [${outputs.join(", ")}]. What is the median?`,
          hint: `Sort and pick middle.`,
          solution: `Sort values, choose middle (average two middles if even).`
        };
      },
      (rng, diff) => { // Template 2: Mean
        const ctx = contexts.class;
        const n = randInt(rng, 5, 9);
        const data = Array.from({length: n}, () => randInt(rng, 60, 100));
        return {
          text: `In ${choice(rng, names)}'s ${ctx.place}, ${n} ${ctx.people} received test scores: [${data.join(", ")}]. What is the mean (average) score?`,
          hint: `Mean = (Sum of all scores) / (Number of scores).`,
          solution: `Sum = ${data.reduce((a,b)=>a+b, 0)}. Mean = Sum / ${n}.`
        };
      },
      (rng, diff) => { // Template 3: Range
        const ctx = contexts.gym;
        const n = 7; // 7 days in a week
        const data = Array.from({length: n}, () => randInt(rng, 20, diff.range + 20));
        return {
          text: `The ${ctx.place} tracks daily visitors for a week: [${data.join(", ")}]. What is the range of the visitor data?`,
          hint: `Range = Maximum value - Minimum value.`,
          solution: `Find the highest and lowest numbers in the list and subtract them.`
        };
      }
    ],
    solving: (rng, diff) => {
      const n = randInt(rng, 6, 12), k = randInt(rng, 1, 5);
      return {
        text: `In a data set of ${n} values, ${k} are outliers. Explain how removing outliers affects mean vs median.`,
        hint: `Mean is sensitive; median is robust.`,
        solution: `Mean shifts more; median changes little unless many outliers.`
      };
    }
  }
};

/* ========= Mixed branch ========= */
// --- MODIFIED to handle arrays of templates ---
function generateMixed(rng, diff, style) {
  const keys = Object.keys(Branches).filter(k => k !== "mixed");
  const k = choice(rng, keys);
  
  let templateSource = Branches[k][style]; // e.g., Branches.arithmetic.word
  if (Array.isArray(templateSource)) {
    // If it's an array (like 'word'), pick one at random
    return choice(rng, templateSource)(rng, diff);
  } else {
    // If it's a single function (like 'normal'), just call it
    return templateSource(rng, diff);
  }
}

/* ========= Main generator ========= */
// --- MODIFIED to handle arrays of templates ---
function genProblem({difficulty, branch, style, seedStr}) {
  const diff = DIFFS[difficulty] || DIFFS.medium;
  const rng = makeRng(seedStr);

  let payload;
  if (branch === "mixed") {
    payload = generateMixed(rng, diff, style);
  } else {
    let templateSource = Branches[branch][style];
    if (Array.isArray(templateSource)) {
      // It's an array of templates (e.g., 'word')
      payload = choice(rng, templateSource)(rng, diff);
    } else {
      // It's a single template (e.g., 'normal', 'solving')
      payload = templateSource(rng, diff);
    }
  }

  // Add occasional multi-step twist for higher difficulties
  if (diff.steps >= 3 && style !== "word problem") {
    if (rng() < 0.5) {
      const x = randInt(rng, 2, 9), y = randInt(rng, 1, 9);
      payload.text += ` Then, using your result r, solve: ${x}r + ${y} = ?`;
      payload.hint += ` Use r from the first part to compute ${x}r + ${y}.`;
      payload.solution += ` Substitute r and evaluate ${x}r + ${y}.`;
    }
  }

  return payload;
}

/* ========= UI wiring ========= */
const difficultyEl = document.getElementById("difficulty");
const branchEl = document.getElementById("branch");
const styleEl = document.getElementById("style");
const seedEl = document.getElementById("seed");
const generateBtn = document.getElementById("generateBtn");
const problemBox = document.getElementById("problemBox");
const problemTextEl = document.getElementById("problemText");
const hintEl = document.getElementById("hint");
const solutionEl = document.getElementById("solution");
const metaEl = document.getElementById("meta");
const copyBtn = document.getElementById("copyBtn");
const shareBtn = document.getElementById("shareBtn");

// This flag tracks if the user has manually interacted with the seed input
let userHasInteractedWithSeed = false;

// Listen for user input on the seed box
seedEl.addEventListener("input", () => {
  userHasInteractedWithSeed = true;
});

function randomSeed() {
  // Use crypto if available; fallback to time-based
  const arr = new Uint32Array(4);
  if (window.crypto && crypto.getRandomValues) {
    crypto.getRandomValues(arr);
    return `${arr[0]}-${arr[1]}-${arr[2]}-${arr[3]}`;
  }
  return `${Date.now()}-${Math.random().toString(16).slice(2)}`;
}

function getSeedFromURL() {
  const params = new URLSearchParams(location.search);
  return params.get("seed");
}

function render() {
  const difficulty = difficultyEl.value; // This will be "easy", "medium", etc.
  const branch = branchEl.value;
  const styleMap = {
    "normal": "normal",
    "word problem": "word",
    "problem solving problem": "solving"
  };
  const style = styleMap[styleEl.value];

  let seedStr = seedEl.value.trim();

  // --- MODIFIED SEED LOGIC ---
  if (!userHasInteractedWithSeed || !seedStr) {
    seedStr = randomSeed();
  }
  // --- END MODIFIED LOGIC ---

  const payload = genProblem({difficulty, branch, style, seedStr});

  problemTextEl.textContent = payload.text;
  hintEl.textContent = "Hint: " + payload.hint;
  solutionEl.textContent = "Solution sketch: " + payload.solution;

  metaEl.innerHTML = "";
  const metaPieces = [
    // Get the *text* of the selected option for display
    { label: "Difficulty", value: difficultyEl.options[difficultyEl.selectedIndex].text },
    { label: "Branch", value: branch },
    { label: "Style", value: styleEl.value },
    { label: "Seed", value: seedStr }
  ];
  metaPieces.forEach(m => {
    const div = document.createElement("div");
    div.className = "badge";
    div.textContent = `${m.label}: ${m.value}`;
    metaEl.appendChild(div);
  });

  // Update seed field with the actual used seed
  seedEl.value = seedStr;
  // ALWAYS reset the flag after rendering
  userHasInteractedWithSeed = false;
}

generateBtn.addEventListener("click", render);

copyBtn.addEventListener("click", async () => {
  const text = `${problemTextEl.textContent}\nHint: ${hintEl.textContent.replace("Hint: ","")}\nSolution sketch: ${solutionEl.textContent.replace("Solution sketch: ","")}\n[${metaEl.textContent}]`;
  try {
    await navigator.clipboard.writeText(text);
    copyBtn.textContent = "Copied!";
    setTimeout(() => copyBtn.textContent = "Copy problem", 1200);
  } catch {
    copyBtn.textContent = "Copy failed";
    setTimeout(() => copyBtn.textContent = "Copy problem", 1200);
  }
});

shareBtn.addEventListener("click", async () => {
  const url = new URL(location.href);
  const seedVal = seedEl.value.trim() || randomSeed(); 
  url.searchParams.set("seed", seedVal);
  try {
    await navigator.clipboard.writeText(url.toString());
    shareBtn.textContent = "URL copied!";
    setTimeout(() => shareBtn.textContent = "Share URL with seed", 1200);
  } catch {
    shareBtn.textContent = "Copy failed";
    setTimeout(() => shareBtn.textContent = "Share URL with seed", 1200);
  }
});

/* ========= Auto-load with URL seed ========= */
window.addEventListener("DOMContentLoaded", () => {
  const urlSeed = getSeedFromURL();
  if (urlSeed) {
    seedEl.value = urlSeed;
    userHasInteractedWithSeed = true; 
  }
  
  const params = new URLSearchParams(location.search);
  const urlDifficulty = params.get("difficulty");
  if (urlDifficulty && DIFFS.hasOwnProperty(urlDifficulty)) {
      difficultyEl.value = urlDifficulty;
  }
  
  render();
});
</script>
</body>
</html>
